<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ê†°Âõ≠Ê¥ªÂä®Êô∫ËÉΩË∞ÉÂ∫¶Á≥ªÁªü</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* === Áé∞‰ª£ÂåñËÆæËÆ°ÂèòÈáè === */
        :root {

            --primary: #F97316;  /* ‰∫ÆÊ©ôËâ≤ */
            --primary-dark: #EA580C;
            --success: #48bb78;
            --danger: #f56565;
            --warning: #ed8936;
            --info: #4299e1;
            
            --gray-50: #f9fafb;
            --gray-100: #f7fafc;
            --gray-200: #edf2f7;
            --gray-300: #e2e8f0;
            --gray-400: #cbd5e0;
            --gray-500: #a0aec0;
            --gray-600: #718096;
            --gray-700: #4a5568;
            --gray-800: #2d3748;
            --gray-900: #1a202c;
            
            --white: #ffffff;
            --black: #000000;
            
            /* Âæ∑Êô∫‰ΩìÁæéÂä≥È¢úËâ≤ */
            --de-color: #8b5cf6;  /* Âæ∑ËÇ≤ - Á¥´Ëâ≤ */
            --zhi-color: #3b82f6; /* Êô∫ËÇ≤ - ËìùËâ≤ */
            --ti-color: #10b981;  /* ‰ΩìËÇ≤ - ÁªøËâ≤ */
            --mei-color: #f59e0b; /* ÁæéËÇ≤ - Ê©ôËâ≤ */
            --lao-color: #ef4444; /* Âä≥ËÇ≤ - Á∫¢Ëâ≤ */
            
            --sidebar-width: 280px;
            --header-height: 80px;
            
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow:  0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg:  0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        /* === Âü∫Á°ÄÈáçÁΩÆ === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background:  var(--gray-50);
            color: var(--gray-900);
            line-height: 1.6;
        }

        /* === ÁôªÂΩï/Ê≥®ÂÜåÁïåÈù¢ === */
        #auth-view {
            min-height: 100vh;
            display:  flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #FDBA74 0%, #F97316 100%);
            position: relative;
            overflow: hidden;
        }

        #auth-view::before {
            content:  '';
            position:  absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height:  200%;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Ccircle cx='30' cy='30' r='2'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E") repeat;
            animation:  float 20s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        .auth-container {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 48px;
            width: 100%;
            max-width:  520px;
            box-shadow: var(--shadow-xl);
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            z-index: 10;
            animation: slideInUp 0.6s ease-out;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity:  1;
                transform: translateY(0);
            }
        }

        .auth-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .auth-header h1 {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
        }

        .auth-header p {
            color: var(--gray-600);
            font-size: 16px;
            font-weight: 500;
        }

        .auth-tabs {
            display:  flex;
            background: var(--gray-100);
            border-radius: 16px;
            padding: 6px;
            margin-bottom: 32px;
        }

        .auth-tab {
            flex: 1;
            padding: 14px 24px;
            border-radius: 12px;
            border: none;
            background: transparent;
            color:  var(--gray-600);
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .auth-tab.active {
            background: var(--white);
            color:  var(--primary);
            box-shadow: var(--shadow-sm);
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display:  block;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid var(--gray-200);
            border-radius: 16px;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.2s ease;
            background:  var(--white);
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 18px 32px;
            border-radius: 16px;
            font-weight: 600;
            font-size: 16px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--white);
            box-shadow: var(--shadow);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background:  linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition:  left 0.5s;
        }

        .btn-primary:hover::before {
            left:  100%;
        }

        .btn-full {
            width:  100%;
        }

        .error-message, .success-message {
            padding: 16px 20px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 20px;
            display: none;
            animation: slideInDown 0.3s ease;
        }

        .error-message {
            background: rgba(245, 101, 101, 0.1);
            color: var(--danger);
            border: 1px solid rgba(245, 101, 101, 0.2);
        }

        .success-message {
            background:  rgba(72, 187, 120, 0.1);
            color:  var(--success);
            border: 1px solid rgba(72, 187, 120, 0.2);
        }

        /* === ‰∏ªÁïåÈù¢Â∏ÉÂ±Ä === */
        #main-view {
            display:  none;
            height: 100vh;
            background: var(--gray-50);
        }

        .app-layout {
            display:  flex;
            height: 100vh;
        }

        /* === ‰æßËæπÊ†èËÆæËÆ° === */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--white);
            border-right:  1px solid var(--gray-200);
            display: flex;
            flex-direction: column;
            position: fixed;
            left: 0;
            top: 0;
            height:  100vh;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .sidebar-header {
            padding: 32px 24px 24px;
            border-bottom: 1px solid var(--gray-200);
            position: relative;
        }

        .user-profile {
            display:  flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }

        .user-avatar-large {
            width:  56px;
            height: 56px;
            border-radius: 20px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: 700;
            font-size: 24px;
            box-shadow: var(--shadow);
        }

        .user-info h3 {
            font-size: 18px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 4px;
        }

        .user-info p {
            font-size: 14px;
            color:  var(--gray-600);
            font-weight: 500;
        }

        .nav-menu {
            flex: 1;
            padding: 24px 16px;
            overflow-y: auto;
        }

        .nav-item {
            margin-bottom: 8px;
            padding: 16px 20px;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 16px;
            color: var(--gray-600);
            font-weight: 600;
            font-size: 15px;
            position: relative;
        }

        .nav-item:hover {
            background: var(--gray-100);
            color:  var(--gray-800);
            transform: translateX(4px);
        }

        .nav-item.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--white);
            box-shadow: var(--shadow);
        }

        .nav-item .nav-icon {
            font-size: 20px;
        }

        .nav-item .nav-badge {
            position:  absolute;
            right: 16px;
            background: var(--danger);
            color:  var(--white);
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
        }

        .sidebar-footer {
            padding: 24px;
            border-top: 1px solid var(--gray-200);
        }

        .logout-btn {
            width: 100%;
            padding: 14px 20px;
            background: var(--gray-100);
            border:  none;
            border-radius: 12px;
            color: var(--gray-600);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap:  8px;
        }

        .logout-btn:hover {
            background:  var(--danger);
            color:  var(--white);
        }

        /* === ‰∏ªÂÜÖÂÆπÂå∫Âüü === */
        .main-content {
            margin-left: var(--sidebar-width);
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .content-header {
            height: var(--header-height);
            background:  var(--white);
            border-bottom: 1px solid var(--gray-200);
            padding: 0 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .page-title {
            display: flex;
            align-items: center;
            gap:  16px;
        }

        .page-title h1 {
            font-size: 28px;
            font-weight: 700;
            color:  var(--gray-900);
        }

        .page-title .title-icon {
            font-size: 32px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .refresh-btn {
            padding: 12px 20px;
            background: var(--primary);
            color:  var(--white);
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition:  all 0.2s ease;
            display: flex;
            align-items: center;
            gap:  8px;
        }

        .refresh-btn:hover {
            background:  var(--primary-dark);
            transform: translateY(-1px);
        }

        .content-body {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
        }

        .activities-grid {
            display:  grid;
            grid-template-columns:  repeat(auto-fill, minmax(400px, 1fr));
            gap: 32px;
            margin-top: 24px;
        }

        .activity-card {
            background: var(--white);
            border-radius: 24px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            border: 1px solid var(--gray-200);
        }

        .activity-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-xl);
        }

        .activity-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--de-color), var(--zhi-color), var(--ti-color), var(--mei-color), var(--lao-color));
        }

        .activity-header {
            padding: 24px 24px 16px;
            position: relative;
        }

        .activity-category {
            position:  absolute;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .category-de { background: rgba(139, 92, 246, 0.1); color: var(--de-color); }
        .category-zhi { background: rgba(59, 130, 246, 0.1); color: var(--zhi-color); }
        .category-ti { background: rgba(16, 185, 129, 0.1); color: var(--ti-color); }
        .category-mei { background:  rgba(245, 158, 11, 0.1); color: var(--mei-color); }
        .category-lao { background: rgba(239, 68, 68, 0.1); color: var(--lao-color); }

        .activity-title {
            font-size: 20px;
            font-weight: 700;
            color:  var(--gray-900);
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .activity-description {
            color:  var(--gray-600);
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 16px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .activity-meta {
            display:  grid;
            grid-template-columns: 1fr 1fr;
            gap:  16px;
            padding:  0 24px 16px;
        }

        .meta-item {
            display: flex;
            align-items:  center;
            gap: 8px;
            color: var(--gray-600);
            font-size:  14px;
        }

        .meta-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content:  center;
            background: var(--gray-100);
            border-radius: 6px;
            font-size: 12px;
        }

        .activity-stats {
            padding: 20px 24px;
            background: var(--gray-50);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stats-left {
            display:  flex;
            align-items: center;
            gap: 16px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap:  6px;
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-700);
        }

        .activity-status {
            padding:  6px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-upcoming { background: rgba(66, 153, 225, 0.1); color: var(--info); }
        .status-ongoing { background: rgba(72, 187, 120, 0.1); color: var(--success); }
        .status-ended { background: rgba(160, 174, 192, 0.1); color: var(--gray-500); }

        .join-btn {
            padding:  10px 20px;
            background: linear-gradient(135deg, var(--success), #38a169);
            color: var(--white);
            border:  none;
            border-radius: 12px;
            font-weight: 600;
            cursor:  pointer;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .join-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .join-btn:disabled {
            background: var(--gray-300);
            cursor: not-allowed;
            transform:  none;
        }

        /* === ‰∏™‰∫∫‰∏≠ÂøÉÊ†∑Âºè === */
        .profile-stats {
            display:  grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 24px;
            margin-bottom:  32px;
        }

        .stat-card {
            background: var(--white);
            padding: 24px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            text-align: center;
            border: 1px solid var(--gray-200);
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .stat-icon {
            width:  56px;
            height: 56px;
            margin: 0 auto 16px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size:  24px;
            color: var(--white);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 800;
            color:  var(--gray-900);
            margin-bottom: 8px;
        }

        .stat-label {
            color: var(--gray-600);
            font-size: 14px;
            font-weight: 600;
        }

        /* === ÁÆ°ÁêÜÂëòÊéßÂà∂Èù¢Êùø === */
        .dashboard-grid {
            display:  grid;
            grid-template-columns:  repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .dashboard-card {
            background: var(--white);
            padding: 24px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            border:  1px solid var(--gray-200);
            position: relative;
            overflow: hidden;
        }

        .dashboard-card::before {
            content:  '';
            position:  absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
        }

        .card-header {
            display: flex;
            justify-content:  space-between;
            align-items:  center;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color:  var(--gray-700);
        }

        .card-value {
            font-size: 36px;
            font-weight: 800;
            color:  var(--gray-900);
            margin-bottom: 8px;
        }

        .card-change {
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap:  4px;
        }

        .change-positive { color: var(--success); }
        .change-negative { color: var(--danger); }

        /* === ËµÑÊ∫êË∞ÉÂ∫¶Êó•ÂéÜ === */
        .schedule-calendar {
            background: var(--white);
            border-radius: 20px;
            box-shadow: var(--shadow);
            overflow: hidden;
            border: 1px solid var(--gray-200);
        }

        .calendar-header {
            padding: 24px;
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content:  space-between;
            align-items:  center;
        }

        .calendar-title {
            font-size: 20px;
            font-weight: 700;
            color:  var(--gray-900);
        }

        .calendar-controls {
            display:  flex;
            gap: 12px;
        }

        .calendar-btn {
            padding: 8px 16px;
            background: var(--primary);
            color:  var(--white);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor:  pointer;
            transition: all 0.2s ease;
        }

        .calendar-grid {
            display:  grid;
            /* Example: 1fr for time column + 7 days * 2 time slots = 15 columns */
            grid-template-columns:  120px repeat(14, 1fr);
            gap: 1px;
            background: var(--gray-200);
        }

        .calendar-cell {
            background: var(--white);
            min-height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            padding: 4px;
            text-align: center;
        }
        
        .calendar-cell-content {
            font-size: 11px;
            font-weight: 500;
        }

        .calendar-header-cell {
            background:  var(--gray-100);
            color: var(--gray-700);
            cursor: default;
            font-size: 14px;
        }

        .calendar-time-cell {
            background:  var(--gray-50);
            color:  var(--gray-600);
            cursor: default;
            font-size: 14px;
        }

        .calendar-available {
            background:  rgba(72, 187, 120, 0.1);
        }

        .calendar-available:hover {
            background: rgba(72, 187, 120, 0.3);
        }

        .calendar-occupied {
            background:  rgba(245, 101, 101, 0.1);
            color: var(--danger);
        }

        .calendar-occupied:hover {
            background: rgba(245, 101, 101, 0.3);
        }

        /* === Á≠õÈÄâÂô® === */
        .filters-bar {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            align-items: center;
            padding: 20px 24px;
            background: var(--white);
            border-radius: 16px;
            box-shadow: var(--shadow-sm);
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap:  8px;
        }

        .filter-label {
            font-size:  14px;
            font-weight:  600;
            color: var(--gray-700);
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 14px;
            background: var(--white);
            cursor:  pointer;
        }

        .create-activity-btn {
            margin-left: auto;
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--success), #38a169);
            color:  var(--white);
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition:  all 0.2s ease;
            display: flex;
            align-items: center;
            gap:  8px;
        }

        /* === Ê®°ÊÄÅÊ°Ü === */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:  rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content:  center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: var(--white);
            border-radius:  24px;
            padding: 32px;
            width: 90%;
            max-width:  600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: slideInUp 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content:  space-between;
            align-items:  center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--gray-200);
        }

        .modal-title {
            font-size:  24px;
            font-weight:  700;
            color: var(--gray-900);
        }

        .close-btn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            border: none;
            background: var(--gray-100);
            color: var(--gray-600);
            cursor:  pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size:  20px;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background:  var(--gray-200);
        }

        /* === ÈÄöÁü•Á≥ªÁªü === */
        .notification {
            position: fixed;
            top:  24px;
            right: 24px;
            padding: 16px 24px;
            border-radius: 12px;
            color: var(--white);
            font-weight: 600;
            box-shadow: var(--shadow-lg);
            z-index: 2000;
            opacity: 0;
            transform: translateX(100%);
            transition:  all 0.3s ease;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.success { background: var(--success); }
        .notification.error { background: var(--danger); }
        .notification.warning { background: var(--warning); }
        .notification.info { background: var(--info); }

        /* === ÂìçÂ∫îÂºèËÆæËÆ° === */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 110;
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .activities-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .dashboard-grid, .profile-stats {
                grid-template-columns:  1fr;
            }
        }

        /* === Á©∫Áä∂ÊÄÅ === */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            background: var(--white);
            border-radius: 20px;
            box-shadow: var(--shadow-sm);
            color: var(--gray-500);
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--gray-800);
        }

        .empty-description {
            font-size: 14px;
            margin-bottom: 24px;
        }

        /* === Âä†ËΩΩÂä®Áîª === */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--gray-200);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 40px auto;
        }

        @keyframes spin {
            0% { transform:  rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* === Âä®ÁîªÊïàÊûú === */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform:  translateY(0);
            }
        }

        .fade-in {
            animation:  fadeIn 0.6s ease-out;
        }

        .slide-in-up {
            animation:  slideInUp 0.4s ease-out;
        }
    </style>
</head>
<body>

    <!-- ÁôªÂΩï/Ê≥®ÂÜåÁïåÈù¢ -->
    <section id="auth-view">
        <div class="auth-container">
            <div class="auth-header">
                <h1>üéì Ê†°Âõ≠Êô∫ËÉΩË∞ÉÂ∫¶</h1>
                <p>ËøûÊé•Ê†°Âõ≠ÁîüÊ¥ªÔºåÊô∫ËÉΩÁÆ°ÁêÜÊú™Êù•</p>
            </div>

            <!-- ÁôªÂΩï/Ê≥®ÂÜåÊ†áÁ≠æÈ°µ -->
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login')">ÁôªÂΩï</button>
                <button class="auth-tab" onclick="switchAuthTab('register')">Ê≥®ÂÜå</button>
            </div>

            <!-- ÈîôËØØ/ÊàêÂäüÊèêÁ§∫ -->
            <div id="auth-error" class="error-message"></div>
            <div id="auth-success" class="success-message"></div>

            <!-- ÁôªÂΩïË°®Âçï -->
            <form id="login-form" class="auth-form">
                <div class="form-group">
                    <label class="form-label">Ë∫´‰ªΩËßíËâ≤</label>
                    <select id="login-role" class="form-select">
                        <option value="student">Â≠¶ÁîüË∫´‰ªΩ</option>
                        <option value="admin">ÁÆ°ÁêÜÂëòË∫´‰ªΩ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Áî®Êà∑Âêç</label>
                    <input type="text" id="login-username" class="form-input" placeholder="ËØ∑ËæìÂÖ•Áî®Êà∑Âêç" required>
                </div>
                <div class="form-group">
                    <label class="form-label">ÂØÜÁ†Å</label>
                    <input type="password" id="login-password" class="form-input" placeholder="ËØ∑ËæìÂÖ•ÂØÜÁ†Å" required>
                </div>
                <button type="submit" class="btn btn-primary btn-full">
                    <span></span> ÁôªÂΩï
                </button>
            </form>

            <!-- Ê≥®ÂÜåË°®Âçï -->
            <form id="register-form" class="auth-form" style="display: none;">
                <div class="form-group">
                    <label class="form-label">Ë∫´‰ªΩËßíËâ≤</label>
                    <select id="register-role" class="form-select">
                        <option value="student">Â≠¶ÁîüË∫´‰ªΩ</option>
                        <option value="admin">ÁÆ°ÁêÜÂëòË∫´‰ªΩ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Áî®Êà∑Âêç</label>
                    <input type="text" id="register-username" class="form-input" placeholder="ËØ∑ËæìÂÖ•Áî®Êà∑ÂêçÔºàËá≥Â∞ë3‰ΩçÔºâ" required>
                </div>
                <div class="form-group">
                    <label class="form-label">ÁúüÂÆûÂßìÂêç</label>
                    <input type="text" id="register-realname" class="form-input" placeholder="ËØ∑ËæìÂÖ•ÁúüÂÆûÂßìÂêç" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Áè≠Á∫ß</label>
                    <input type="text" id="register-class" class="form-input" placeholder="ËØ∑ËæìÂÖ•Áè≠Á∫ß" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Â≠¶Èô¢</label>
                    <input type="text" id="register-college" class="form-input" placeholder="ËØ∑ËæìÂÖ•Â≠¶Èô¢" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Â≠¶Âè∑</label>
                    <input type="text" id="register-student-id" class="form-input" placeholder="ËØ∑ËæìÂÖ•Â≠¶Âè∑" required>
                </div>
                <div class="form-group">
                    <label class="form-label">ÈÇÆÁÆ±Âú∞ÂùÄ</label>
                    <input type="email" id="register-email" class="form-input" placeholder="ËØ∑ËæìÂÖ•ÈÇÆÁÆ±Âú∞ÂùÄ" required>
                </div>
                <div class="form-group">
                    <label class="form-label">ÂØÜÁ†Å</label>
                    <input type="password" id="register-password" class="form-input" placeholder="ËØ∑ËæìÂÖ•ÂØÜÁ†ÅÔºàËá≥Â∞ë6‰ΩçÔºâ" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Á°ÆËÆ§ÂØÜÁ†Å</label>
                    <input type="password" id="register-confirm" class="form-input" placeholder="ËØ∑ÂÜçÊ¨°ËæìÂÖ•ÂØÜÁ†Å" required>
                </div>
                <button type="submit" class="btn btn-primary btn-full">
                    <span></span> Á´ãÂç≥Ê≥®ÂÜå
                </button>
            </form>
            <div style="text-align: center; margin-top: 24px; font-size: 14px; color: var(--gray-500);">
                <p>ÊºîÁ§∫Ë¥¶Êà∑Ôºöadmin / admin123 Êàñ student / student123</p>
            </div>
        </div>
    </section>

    <!-- ‰∏ªÂ∫îÁî®ÁïåÈù¢ -->
    <section id="main-view" style="display: none;">
        <div class="app-layout">
            <!-- ‰æßËæπÊ†è -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <div class="user-profile">
                        <div class="user-avatar-large" id="user-avatar-large">U</div>
                        <div class="user-info">
                            <h3 id="user-display-name">Áî®Êà∑ÂßìÂêç</h3>
                            <p id="user-display-id">ID: 2021001</p>
                        </div>
                    </div>
                </div>
                <nav class="nav-menu" id="nav-menu">
                    <!-- Âä®ÊÄÅÁîüÊàêÂØºËà™ -->
                </nav>
                <div class="sidebar-footer">
                    <button class="logout-btn" onclick="handleLogout()">
                        <span></span> ÈÄÄÂá∫ÁôªÂΩï
                    </button>
                </div>
            </div>

            <!-- ‰∏ªÂÜÖÂÆπÂå∫ -->
            <div class="main-content">
                <header class="content-header">
                    <div class="page-title">
                        <span class="title-icon" id="page-icon"></span>
                        <h1 id="page-title-text">Ê¥ªÂä®ÂπøÂú∫</h1>
                    </div>
                    <div class="header-actions">
                        <button class="refresh-btn" onclick="refreshData()">
                            <span></span> Âà∑Êñ∞Êï∞ÊçÆ
                        </button>
                    </div>
                </header>

                <div class="content-body">
                    <!-- Ê¥ªÂä®ÂπøÂú∫ÔºàÈÄöÁî®Ôºâ -->
                    <div id="tab-activities" class="tab-content">
                        <div class="filters-bar">
                            <div class="filter-group">
                                <span class="filter-label">Ê¥ªÂä®ÂàÜÁ±ªÔºö</span>
                                <select id="category-filter" class="filter-select" onchange="filterActivities()">
                                    <option value="all">ÂÖ®ÈÉ®Ê¥ªÂä®</option>
                                    <option value="de">Âæ∑ËÇ≤Ê¥ªÂä®</option>
                                    <option value="zhi">Êô∫ËÇ≤Ê¥ªÂä®</option>
                                    <option value="ti">‰ΩìËÇ≤Ê¥ªÂä®</option>
                                    <option value="mei">ÁæéËÇ≤Ê¥ªÂä®</option>
                                    <option value="lao">Âä≥ËÇ≤Ê¥ªÂä®</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <span class="filter-label">Ê¥ªÂä®Áä∂ÊÄÅÔºö</span>
                                <select id="status-filter" class="filter-select" onchange="filterActivities()">
                                    <option value="all">ÂÖ®ÈÉ®Áä∂ÊÄÅ</option>
                                    <option value="upcoming">Êú™ÂºÄÂßã</option>
                                    <option value="ongoing">ËøõË°å‰∏≠</option>
                                    <option value="ended">Â∑≤ÁªìÊùü</option>
                                </select>
                            </div>
                            <!-- ÁÆ°ÁêÜÂëò‰∏ìÔøΩÔøΩÂàõÂª∫ÊåâÈíÆ -->
                            <button id="create-activity-btn-placeholder" class="create-activity-btn" style="display: none;" onclick="showCreateActivityModal()">
                                <span>‚ûï</span> ÂàõÂª∫Ê¥ªÂä®
                            </button>
                        </div>
                        <div class="activities-grid" id="activities-grid">
                            <!-- Ê¥ªÂä®Âç°ÁâáÂä®ÊÄÅÁîüÊàê -->
                        </div>
                    </div>

                    <!-- ËÅîÁ≥ª‰∫∫ÁÆ°ÁêÜ -->
                    <div id="tab-contacts" class="tab-content" style="display: none;">
                        <div class="filters-bar">
                            <div class="filter-group">
                                <input type="text" id="contact-search" class="form-input" placeholder="Âü∫‰∫éTrieÊ†ëÂâçÁºÄÊêúÁ¥¢ËÅîÁ≥ª‰∫∫ÂßìÂêç„ÄÅÁîµËØùÊàñÈÇÆÁÆ±..." oninput="searchContacts()" style="width: 400px; margin: 0;">
                            </div>
                            <button class="create-activity-btn" onclick="showCreateContactModal()">
                                <span></span> Ê∑ªÂä†ËÅîÁ≥ª‰∫∫
                            </button>
                        </div>
                        <div class="activities-grid" id="contacts-grid">
                            <!-- ËÅîÁ≥ª‰∫∫Âç°Áâá -->
                        </div>
                    </div>

                    <!-- ‰∏™‰∫∫‰∏≠ÂøÉ (Â≠¶Áîü) -->
                    <div id="tab-profile" class="tab-content" style="display: none;">
                        <div class="profile-stats">
                            <div class="stat-card">
                                <div class="stat-icon"></div>
                                <div class="stat-value" id="total-study-hours">0</div>
                                <div class="stat-label">Á¥ØËÆ°Â≠¶Êó∂</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon"></div>
                                <div class="stat-value" id="total-contacts">0</div>
                                <div class="stat-label">ËÅîÁ≥ª‰∫∫Êï∞Èáè</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon"></div>
                                <div class="stat-value" id="month-activities">0</div>
                                <div class="stat-label">Êú¨ÊúàÂèÇÂä†Ê¥ªÂä®</div>
                            </div>
                        </div>
                        <h3 style="margin-bottom: 24px; font-size: 20px; font-weight: 700;">ÊàëÊúÄËøëÁöÑÊ¥ªÂä®</h3>
                        <div class="activities-grid" id="my-recent-activities">
                            <!-- ÊúÄËøëÊ¥ªÂä®Âç°Áâá -->
                        </div>
                    </div>

                    <!-- ÊéßÂà∂Èù¢Êùø (ÁÆ°ÁêÜÂëò) -->
                    <div id="tab-dashboard" class="tab-content" style="display: none;">
                        <div class="dashboard-grid">
                            <div class="dashboard-card">
                                <div class="card-header">
                                    <span class="card-title">ÊÄªÊ¥ªÂä®Êï∞Èáè</span>
                                    <span style="font-size: 24px;"></span>
                                </div>
                                <div class="card-value" id="dashboard-total-activities">0</div>
                                <div class="card-change change-positive">
                                    <span></span> +0 ËæÉ‰∏äÂë®
                                </div>
                            </div>
                            <div class="dashboard-card">
                                <div class="card-header">
                                    <span class="card-title">ËøõË°å‰∏≠Ê¥ªÂä®</span>
                                    <span style="font-size: 24px;">üîÑ</span>
                                </div>
                                <div class="card-value" id="dashboard-ongoing-activities">0</div>
                                <div class="card-change change-positive">
                                    <span></span> +0 ËæÉÊò®Êó•
                                </div>
                            </div>
                            <div class="dashboard-card">
                                <div class="card-header">
                                    <span class="card-title">ËµÑÊ∫êÂà©Áî®Áéá</span>
                                    <span style="font-size: 24px;"></span>
                                </div>
                                <div class="card-value" id="dashboard-resource-usage">0%</div>
                                <div class="card-change change-negative">
                                    <span></span> -0% ËæÉ‰∏äÂë®
                                </div>
                            </div>
                             <div class="dashboard-card">
                                <div class="card-header">
                                    <span class="card-title">ÊÄªÁî®Êà∑Êï∞</span>
                                    <span style="font-size: 24px;"></span>
                                </div>
                                <div class="card-value" id="dashboard-total-users">0</div>
                                <div class="card-change change-positive">
                                    <span></span> +0 Êñ∞Áî®Êà∑
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ËµÑÊ∫êË∞ÉÂ∫¶ (ÁÆ°ÁêÜÂëò) -->
                    <div id="tab-schedule" class="tab-content" style="display: none;">
                        <div class="schedule-calendar">
                            <div class="calendar-header">
                                <h3 class="calendar-title">Êô∫ËÉΩËµÑÊ∫êË∞ÉÂ∫¶ - Á∫øÊÆµÊ†ëÂÜ≤Á™ÅÊ£ÄÊµãÂèØËßÜÂåñ</h3>
                                <div class="calendar-controls">
                                    <button class="calendar-btn">‰∏ä‰∏ÄÂë®</button>
                                    <button class="calendar-btn">Êú¨Âë®</button>
                                    <button class="calendar-btn">‰∏ã‰∏ÄÂë®</button>
                                </div>
                            </div>
                            <div class="calendar-grid" id="schedule-grid">
                                <!-- Âä®ÊÄÅÁîüÊàêË∞ÉÂ∫¶Ë°®Ê†º -->
                            </div>
                        </div>
                        <div style="margin-top: 24px; padding: 20px; background: var(--white); border-radius: 16px; box-shadow: var(--shadow-sm);">
                            <h4 style="margin-bottom: 12px; font-size: 16px; font-weight: 600;">Âõæ‰æãËØ¥Êòé</h4>
                            <div style="display: flex; gap: 24px; flex-wrap: wrap;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <div style="width: 20px; height: 20px; background: rgba(72, 187, 120, 0.2); border-radius: 4px;"></div>
                                    <span style="font-size: 14px;">ÂèØÁî®Êó∂ÊÆµ</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <div style="width: 20px; height: 20px; background: rgba(245, 101, 101, 0.2); border-radius: 4px;"></div>
                                    <span style="font-size: 14px;">Â∑≤Âç†Áî®Êó∂ÊÆµ</span>
                                </div>
                                 <div style="display: flex; align-items: center; gap: 8px;">
                                    <div style="width: 20px; height: 20px; background: var(--gray-100); border: 1px solid var(--gray-200); border-radius: 4px;"></div>
                                    <span style="font-size: 14px;">Êó∂Èó¥/Âú∫Âú∞Ê†áÈ¢ò</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- ÂàõÂª∫/ÁºñËæëÊ¥ªÂä®Ê®°ÊÄÅÊ°Ü -->
    <div id="create-activity-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="activity-modal-title">ÂàõÂª∫Êñ∞Ê¥ªÂä®</h3>
                <button class="close-btn" onclick="closeModal('create-activity-modal')">&times;</button>
            </div>
            <form id="create-activity-form">
                <input type="hidden" id="activity-id">
                <div class="form-group">
                    <label class="form-label">Ê¥ªÂä®ÂêçÁß∞</label>
                    <input type="text" id="activity-name" class="form-input" placeholder="ËØ∑ËæìÂÖ•Ê¥ªÂä®ÂêçÁß∞" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Ê¥ªÂä®ÊèèËø∞</label>
                    <textarea id="activity-description" class="form-input" placeholder="ËØ∑ËæìÂÖ•Ê¥ªÂä®ÊèèËø∞" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Ê¥ªÂä®Âú∞ÁÇπ</label>
                    <input type="text" id="activity-location" class="form-input" placeholder="ËØ∑ËæìÂÖ•Ê¥ªÂä®Âú∞ÁÇπ" required>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label">ÂºÄÂßãÊó∂Èó¥</label>
                        <input type="datetime-local" id="activity-start" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÁªìÊùüÊó∂Èó¥</label>
                        <input type="datetime-local" id="activity-end" class="form-input" required>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label">ÊúÄÂ§ßÂèÇ‰∏é‰∫∫Êï∞</label>
                        <input type="number" id="activity-max-participants" class="form-input" placeholder="50" min="1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ê¥ªÂä®Á±ªÂà´</label>
                        <select id="activity-category" class="form-select" required>
                            <option value="de">Âæ∑ËÇ≤Ê¥ªÂä®</option>
                            <option value="zhi">Êô∫ËÇ≤Ê¥ªÂä®</option>
                            <option value="ti">‰ΩìËÇ≤Ê¥ªÂä®</option>
                            <option value="mei">ÁæéËÇ≤Ê¥ªÂä®</option>
                            <option value="lao">Âä≥ËÇ≤Ê¥ªÂä®</option>
                        </select>
                    </div>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--gray-200);">
                    <button type="button" class="btn" style="background: var(--gray-100); color: var(--gray-700);" onclick="closeModal('create-activity-modal')">ÂèñÊ∂à</button>
                    <button type="submit" class="btn btn-primary" id="activity-submit-btn">
                        <span></span> ÂàõÂª∫Ê¥ªÂä®
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ÂàõÂª∫ËÅîÁ≥ª‰∫∫Ê®°ÊÄÅÊ°Ü -->
    <div id="create-contact-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Ê∑ªÂä†ËÅîÁ≥ª‰∫∫</h3>
                <button class="close-btn" onclick="closeModal('create-contact-modal')">&times;</button>
            </div>
            <form id="create-contact-form">
                <div class="form-group">
                    <label class="form-label">ÂßìÂêç</label>
                    <input type="text" id="contact-name" class="form-input" placeholder="ËØ∑ËæìÂÖ•ÂßìÂêç" required>
                </div>
                <div class="form-group">
                    <label class="form-label">ÁîµËØù</label>
                    <input type="tel" id="contact-phone" class="form-input" placeholder="ËØ∑ËæìÂÖ•ÁîµËØùÂè∑Á†Å" required>
                </div>
                <div class="form-group">
                    <label class="form-label">ÈÇÆÁÆ±</label>
                    <input type="email" id="contact-email" class="form-input" placeholder="ËØ∑ËæìÂÖ•ÈÇÆÁÆ±Âú∞ÂùÄ" required>
                </div>
                <div class="form-group">
                    <label class="form-label">ÈÉ®Èó®/Â≠¶Èô¢</label>
                    <input type="text" id="contact-department" class="form-input" placeholder="ËØ∑ËæìÂÖ•ÈÉ®Èó®ÊàñÂ≠¶Èô¢">
                </div>
                <div class="form-group">
                    <label class="form-label">Â≠¶Âè∑ÔºàÂèØÈÄâÔºâ</label>
                    <input type="text" id="contact-student-id" class="form-input" placeholder="Â¶ÇÊûúÊòØÂ≠¶ÁîüÔºåËØ∑ËæìÂÖ•Â≠¶Âè∑">
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--gray-200);">
                    <button type="button" class="btn" style="background: var(--gray-100); color: var(--gray-700);" onclick="closeModal('create-contact-modal')">ÂèñÊ∂à</button>
                    <button type="submit" class="btn btn-primary">
                        <span></span> Ê∑ªÂä†ËÅîÁ≥ª‰∫∫
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Ê¥ªÂä®ËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü -->
    <div id="activity-detail-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title" id="detail-activity-title">Ê¥ªÂä®ËØ¶ÊÉÖ</h3>
                <button class="close-btn" onclick="closeModal('activity-detail-modal')">&times;</button>
            </div>
            <div id="activity-detail-content">
                <!-- Ê¥ªÂä®ËØ¶ÊÉÖÂÜÖÂÆπÂä®ÊÄÅÁîüÊàê -->
            </div>
        </div>
    </div>
    
    <!-- ÈÄöÁü•ÂÆπÂô® -->
    <div id="notification-container" style="position: fixed; top: 24px; right: 24px; z-index: 2000; display: flex; flex-direction: column; gap: 12px;"></div>


    <script>
        console.log(' Ê†°Âõ≠Ê¥ªÂä®Êô∫ËÉΩË∞ÉÂ∫¶Á≥ªÁªü ÂàùÂßãÂåñ...');
        
        // --- ÂÖ®Â±ÄÁä∂ÊÄÅÂíåÂèòÈáè ---
        const API_BASE = 'http://localhost:8080';
        let authToken = localStorage.getItem('authToken');
        let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
        let allActivities = []; // ÂÖ®Â±ÄÊ¥ªÂä®ÁºìÂ≠ò
        let allContacts = [];   // ÂÖ®Â±ÄËÅîÁ≥ª‰∫∫ÁºìÂ≠ò
        
        // --- APIËØ∑Ê±ÇÂ∞ÅË£ÖÂáΩÊï∞ ---
        async function apiRequest(endpoint, options = {}) {
            const url = `${API_BASE}${endpoint}`;
            
            const defaultHeaders = {
                'Content-Type': 'application/json',
            };
            
            if (authToken) {
                defaultHeaders['Authorization'] = `Bearer ${authToken}`;
            }
            
            const config = {
                method: 'GET',
                headers: defaultHeaders,
                ...options,
                headers: { ...defaultHeaders, ...options.headers }
            };
            
            if (options.body && typeof options.body === 'object') {
                config.body = JSON.stringify(options.body);
            }
            
            try {
                const response = await fetch(url, config);
                
                let data;
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    const text = await response.text();
                    try {
                        data = JSON.parse(text);
                    } catch (e) {
                        data = text;
                    }
                }
                
                if (!response.ok) {
                    if (response.status === 401) {
                        handleLogout();
                        throw new Error('ÁôªÂΩïÂ∑≤ËøáÊúüÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï');
                    }
                    throw new Error(data.error || `HTTP ${response.status}: ${response.statusText}`);
                }
                
                return data;
            } catch (error) {
                console.error('APIËØ∑Ê±ÇÈîôËØØ:', error);
                // ‰∏çÂú®ËøôÈáåÊòæÁ§∫ÈÄöÁü•ÔºåËÆ©Ë∞ÉÁî®ÊñπÂ§ÑÁêÜ
                throw error;
            }
        }
        
        // --- ÂØºËà™Ê†èÂÆö‰πâ ---
        const navConfig = {
            student: [
                { id: 'activities', name: 'Ê¥ªÂä®ÂπøÂú∫', icon: '' },
                { id: 'contacts', name: 'ËÅîÁ≥ª‰∫∫ÁÆ°ÁêÜ', icon: '' },
                { id: 'profile', name: '‰∏™‰∫∫‰∏≠ÂøÉ', icon: '' }
            ],
            admin: [
                { id: 'dashboard', name: 'ÊéßÂà∂Èù¢Êùø', icon: '' },
                { id: 'activities', name: 'Ê¥ªÂä®ÁÆ°ÁêÜ', icon: '' },
                { id: 'schedule', name: 'ËµÑÊ∫êË∞ÉÂ∫¶', icon: '' },
                { id: 'contacts', name: 'ËÅîÁ≥ª‰∫∫ÁÆ°ÁêÜ', icon: '' }
            ]
        };

        // --- È°µÈù¢Âä†ËΩΩÂÖ•Âè£ ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOMÂä†ËΩΩÂÆåÊàêÔºåÂºÄÂßãÂàùÂßãÂåñÂ∫îÁî®');
            console.log('localStorage.authToken:', localStorage.getItem('authToken')?.substring(0, 20) + '...' || 'null');
            console.log('localStorage.currentUser:', localStorage.getItem('currentUser'));
            console.log('Global currentUser:', currentUser);
            bindFormEvents();
            if (currentUser && authToken) {
                console.log(`Ê£ÄÊµãÂà∞Â∑≤ÁôªÂΩïÁî®Êà∑: ${currentUser.username} (ËßíËâ≤: ${currentUser.role})`);
                showMainView();
            } else {
                console.log('Êú™Ê£ÄÊµãÂà∞ÁôªÂΩïÁä∂ÊÄÅÔºåÊòæÁ§∫ËÆ§ËØÅÈ°µÈù¢');
                showAuthView();
            }
        });

        // --- ËßÜÂõæÂàáÊç¢ ---
        function showAuthView() {
            document.getElementById('auth-view').style.display = 'flex';
            document.getElementById('main-view').style.display = 'none';
        }

        function showMainView() {
            document.getElementById('auth-view').style.display = 'none';
            document.getElementById('main-view').style.display = 'block';
            setupMainInterface();
        }
        
        function switchAuthTab(tab) {
            document.getElementById('login-form').style.display = tab === 'login' ? 'block' : 'none';
            document.getElementById('register-form').style.display = tab === 'register' ? 'block' : 'none';
            document.querySelector('.auth-tab.active').classList.remove('active');
            document.querySelector(`.auth-tab[onclick="switchAuthTab('${tab}')"]`).classList.add('active');
            clearMessages();
        }
        
        // --- ‰∏ªÁïåÈù¢ËÆæÁΩÆ ---
        function setupMainInterface() {
            if (!currentUser) return;
            // 1. ËÆæÁΩÆÁî®Êà∑‰ø°ÊÅØ
            const user = currentUser;
            document.getElementById('user-display-name').textContent = user.realName || user.username;
            document.getElementById('user-avatar-large').textContent = (user.realName || user.username).charAt(0).toUpperCase();
            document.getElementById('user-display-id').textContent = user.role === 'student' ? `Â≠¶Âè∑: ${user.studentId}` : `ËßíËâ≤: ÁÆ°ÁêÜÂëò`;

            // 2. ÁîüÊàêÂØºËà™Ê†è
            const navMenu = document.getElementById('nav-menu');
            navMenu.innerHTML = '';
            const userNav = navConfig[user.role] || [];
            userNav.forEach(item => {
                const navItem = document.createElement('div');
                navItem.className = 'nav-item';
                navItem.dataset.tab = `tab-${item.id}`;
                navItem.innerHTML = `<span class="nav-icon">${item.icon}</span> ${item.name}`;
                navItem.onclick = () => switchTab(item.id, item.name, item.icon);
                navMenu.appendChild(navItem);
            });
            
            // 3. Ê†πÊçÆËßíËâ≤Ë∞ÉÊï¥UI
            const createBtn = document.getElementById('create-activity-btn-placeholder');
            if (user.role === 'admin') {
                createBtn.style.display = 'flex';
            } else {
                createBtn.style.display = 'none';
            }
            
            // 4. ËÆæÁΩÆÈªòËÆ§Ê†áÁ≠æÈ°µÂπ∂Âä†ËΩΩÊï∞ÊçÆ
            const defaultTab = userNav[0];
            if (defaultTab) {
                switchTab(defaultTab.id, defaultTab.name, defaultTab.icon);
            }
        }
        
        function switchTab(tabId, tabName, tabIcon) {
            console.log(`ÂàáÊç¢Âà∞Ê†áÁ≠æÈ°µ: ${tabName}`);
            // ÈöêËóèÊâÄÊúâÂÜÖÂÆπ
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            
            // ÊòæÁ§∫ÁõÆÊ†áÂÜÖÂÆπ
            const targetTab = document.getElementById(`tab-${tabId}`);
            if (targetTab) {
                targetTab.style.display = 'block';
                document.getElementById('page-title-text').textContent = tabName;
                document.getElementById('page-icon').textContent = tabIcon;
                
                // ÊøÄÊ¥ªÂØºËà™È°π
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.tab === `tab-${tabId}`);
                });
                
                // ÊåâÈúÄÂä†ËΩΩÊï∞ÊçÆ
                loadDataForTab(tabId);
            }
        }
        
        async function loadDataForTab(tabId) {
            showLoadingSpinnerForTab(tabId, true);
            try {
                switch(tabId) {
                    case 'activities':
                        await fetchAllActivities();
                        break;
                    case 'contacts':
                        await fetchAllContacts();
                        break;
                    case 'profile':
                        await Promise.all([fetchAllActivities(), fetchAllContacts()]);
                        renderProfileData();
                        break;
                    case 'dashboard':
                        await fetchAllActivities(); // ÂÅáËÆæ‰ª™Ë°®ÁõòÈúÄË¶ÅÊ¥ªÂä®Êï∞ÊçÆ
                        renderDashboardData();
                        break;
                    case 'schedule':
                        renderScheduleGrid();
                        break;
                }
            } catch (error) {
                console.error(`Âä†ËΩΩ ${tabId} Êï∞ÊçÆÂ§±Ë¥•:`, error);
                showNotification(`Âä†ËΩΩ${tabId}Êï∞ÊçÆÂ§±Ë¥•`, 'error');
            } finally {
                showLoadingSpinnerForTab(tabId, false);
            }
        }
        
        function refreshData() {
            const activeTab = document.querySelector('.nav-item.active');
            if (activeTab) {
                const tabId = activeTab.dataset.tab.replace('tab-', '');
                showNotification('Ê≠£Âú®Âà∑Êñ∞Êï∞ÊçÆ...', 'info');
                loadDataForTab(tabId);
            }
        }
        
        // --- Êï∞ÊçÆËé∑Âèñ‰∏éÊ∏≤Êüì (Ê®°ÊãüAPI) ---
        async function mockApiCall(data, delay = 500) {
            return new Promise(resolve => setTimeout(() => resolve(data), delay));
        }

        async function fetchAllActivities() {
            console.log("Fetching all activities...");
            try {
                const activities = await apiRequest('/api/activities');
                if (Array.isArray(activities)) {
                    // ËΩ¨Êç¢APIÊï∞ÊçÆÊ†ºÂºèÂà∞ÂâçÁ´ØÈúÄË¶ÅÁöÑÊ†ºÂºè
                    allActivities = activities.map(a => ({
                        id: a.id,
                        name: a.name,
                        description: a.description || '',
                        location: a.location,
                        start: a.start_time,
                        end: a.end_time,
                        maxParticipants: a.max_participants || 0,
                        participants: a.current_participants || 0,
                        category: mapCategoryToFrontend(a.category),
                        creator: a.created_by || 'Á≥ªÁªü'
                    }));
                } else {
                    console.warn('Activities APIËøîÂõûÊ†ºÂºèÂºÇÂ∏∏Ôºå‰ΩøÁî®Ê®°ÊãüÊï∞ÊçÆ');
                    allActivities = [];
                }
                console.log("Activities fetched:", allActivities);
                filterActivities(); // Ëé∑ÂèñÂêéÁ´ãÂç≥Ê∏≤Êüì
            } catch (error) {
                console.error('Ëé∑ÂèñÊ¥ªÂä®Â§±Ë¥•Ôºå‰ΩøÁî®Ê®°ÊãüÊï∞ÊçÆ:', error);
                // ‰ΩøÁî®Ê®°ÊãüÊï∞ÊçÆ‰Ωú‰∏∫ÂêéÂ§á
                const mockActivities = [
                    { id: 1, name: 'Êò•Â≠£Ê†°Âõ≠È©¨ÊãâÊùæ', description: 'ÁéØÁªïÊ†°Âõ≠ÔºåË∑ëÂá∫ÈùíÊò•È£éÈááÔºåÂø´Êù•Êä•ÂêçÂêßÔºÅ', location: 'Â≠¶Ê†°ÊìçÂú∫', start: '2026-03-15T08:00', end: '2026-03-15T11:00', maxParticipants: 200, participants: 152, category: 'ti', creator: '‰ΩìËÇ≤ÈÉ®' },
                    { id: 2, name: 'AIÊäÄÊúØ‰∏éÊú™Êù•‰∏ñÁïåËÆ≤Â∫ß', description: 'Êé¢Á¥¢‰∫∫Â∑•Êô∫ËÉΩÁöÑÂâçÊ≤øÂèëÂ±ï‰∏éÂ∫îÁî®„ÄÇ', location: 'Âõæ‰π¶È¶ÜÊä•ÂëäÂéÖ', start: '2026-03-20T19:00', end: '2026-03-20T21:00', maxParticipants: 100, participants: 100, category: 'zhi', creator: 'ËÆ°ÁÆóÊú∫Â≠¶Èô¢' }
                ];
                allActivities = mockActivities;
                filterActivities();
            }
        }
        
        function mapCategoryToFrontend(category) {
            const map = {
                'academic': 'zhi',
                'sports': 'ti',
                'cultural': 'mei',
                'volunteer': 'de',
                'moral': 'de'
            };
            return map[category] || 'de';
        }

        async function fetchAllContacts() {
            console.log("Fetching all contacts...");
            try {
                const contacts = await apiRequest('/api/contacts');
                if (Array.isArray(contacts)) {
                    allContacts = contacts.map(c => ({
                        id: c.id,
                        name: c.name,
                        phone: c.phone || '',
                        email: c.email || '',
                        department: c.department || '',
                        studentId: c.student_id || null
                    }));
                } else {
                    console.warn('Contacts APIËøîÂõûÊ†ºÂºèÂºÇÂ∏∏Ôºå‰ΩøÁî®Ê®°ÊãüÊï∞ÊçÆ');
                    allContacts = [];
                }
                console.log("Contacts fetched:", allContacts);
                renderContacts(allContacts);
            } catch (error) {
                console.error('Ëé∑ÂèñËÅîÁ≥ª‰∫∫Â§±Ë¥•Ôºå‰ΩøÁî®Ê®°ÊãüÊï∞ÊçÆ:', error);
                // ‰ΩøÁî®Ê®°ÊãüÊï∞ÊçÆ‰Ωú‰∏∫ÂêéÂ§á
                const mockContacts = [
                    { id: 1, name: 'ÁéãËÄÅÂ∏à', phone: '13800138000', email: 'wang.laoshi@example.com', department: 'ËÆ°ÁÆóÊú∫Â≠¶Èô¢' },
                    { id: 2, name: 'ÊùéÂêåÂ≠¶', phone: '13912345678', email: 'li.ÂêåÂ≠¶@example.com', department: 'ËΩØ‰ª∂Â∑•Á®ã2021Á∫ß', studentId: '2021002' }
                ];
                allContacts = mockContacts;
                renderContacts(allContacts);
            }
        }
        
        function filterActivities() {
            const category = document.getElementById('category-filter').value;
            const status = document.getElementById('status-filter').value;
            const filtered = allActivities.filter(activity => {
                const categoryMatch = category === 'all' || activity.category === category;
                const statusMatch = status === 'all' || getActivityStatus(activity).key === status;
                return categoryMatch && statusMatch;
            });
            renderActivities(filtered);
        }
        
        // --- Ê∏≤ÊüìÈÄªËæë ---
        function renderActivities(activities) {
            const grid = document.getElementById('activities-grid');
            grid.innerHTML = '';
            if (activities.length === 0) {
                grid.innerHTML = `<div class="empty-state" style="grid-column: 1 / -1;">
                    <div class="empty-icon"></div>
                    <div class="empty-title">Ê≤°ÊúâÊâæÂà∞Áõ∏ÂÖ≥Ê¥ªÂä®</div>
                    <div class="empty-description">Â∞ùËØïÊõ¥Êç¢Á≠õÈÄâÊù°‰ª∂ÔºåÊàñÁ≠âÂæÖÊñ∞ÁöÑÊ¥ªÂä®ÂèëÂ∏É„ÄÇ</div>
                </div>`;
                return;
            }
            activities.forEach(activity => {
                grid.appendChild(createActivityCard(activity));
            });
        }
        
        function createActivityCard(activity) {
            const card = document.createElement('div');
            card.className = 'activity-card';
            card.onclick = () => showActivityDetailModal(activity.id);

            const status = getActivityStatus(activity);
            const categoryMap = { de: 'Âæ∑ËÇ≤', zhi: 'Êô∫ËÇ≤', ti: '‰ΩìËÇ≤', mei: 'ÁæéËÇ≤', lao: 'Âä≥ËÇ≤' };
            const isFull = activity.participants >= activity.maxParticipants;

            card.innerHTML = `
                <div class="activity-header">
                    <span class="activity-category category-${activity.category}">${categoryMap[activity.category]}</span>
                    <h3 class="activity-title">${activity.name}</h3>
                    <p class="activity-description">${activity.description.substring(0, 40)}...</p>
                </div>
                <div class="activity-meta">
                    <div class="meta-item"><span class="meta-icon">üìç</span> ${activity.location}</div>
                    <div class="meta-item"><span class="meta-icon">üïí</span> ${formatDateTime(activity.start)}</div>
                </div>
                <div class="activity-stats">
                    <div class="stats-left">
                        <div class="stat-item">
                            <span class="activity-status ${status.class}">${status.text}</span>
                        </div>
                        <div class="stat-item">
                            <span>üë•</span> ${activity.participants} / ${activity.maxParticipants}
                        </div>
                    </div>
                    ${currentUser.role === 'student' ? `
                    <button class="join-btn" onclick="event.stopPropagation(); handleJoinActivity(${activity.id})" ${status.key !== 'upcoming' || isFull ? 'disabled' : ''}>
                        ${status.key === 'upcoming' ? (isFull ? 'Â∑≤Êª°Âëò' : 'Êä•Âêç') : 'Â∑≤ÁªìÊùü'}
                    </button>
                    ` : `
                    <button class="join-btn" style="background: var(--info)" onclick="event.stopPropagation(); showCreateActivityModal(${activity.id})">
                        ÁºñËæë
                    </button>
                    `}
                </div>
            `;
            return card;
        }

        function renderContacts(contacts) {
            const grid = document.getElementById('contacts-grid');
            grid.innerHTML = '';
             if (contacts.length === 0) {
                grid.innerHTML = `<div class="empty-state" style="grid-column: 1 / -1;">
                    <div class="empty-icon"></div>
                    <div class="empty-title">Ê≤°ÊúâËÅîÁ≥ª‰∫∫</div>
                    <div class="empty-description">ÁÇπÂáªÂè≥‰∏äËßí‚ÄúÊ∑ªÂä†ËÅîÁ≥ª‰∫∫‚ÄùÊù•ÂàõÂª∫‰Ω†ÁöÑÁ¨¨‰∏Ä‰∏™ËÅîÁ≥ª‰∫∫Âêß„ÄÇ</div>
                </div>`;
                return;
            }
            // Using activity card style for contacts for consistency
            contacts.forEach(contact => {
                const card = document.createElement('div');
                card.className = 'activity-card';
                card.style.cursor = 'default';
                card.innerHTML = `
                    <div class="activity-header">
                        <h3 class="activity-title">${contact.name}</h3>
                        <p class="activity-description">${contact.department || 'Êó†ÈÉ®Èó®‰ø°ÊÅØ'}</p>
                    </div>
                    <div class="activity-meta">
                        <div class="meta-item"><span class="meta-icon">üìû</span> ${contact.phone}</div>
                        <div class="meta-item"><span class="meta-icon">‚úâÔ∏è</span> ${contact.email}</div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }
        
        function renderProfileData() {
            // ÂÆâÂÖ®Ê£ÄÊü•ÔºöÁ°Æ‰øù DOM ÂÖÉÁ¥†Â≠òÂú®
            const studyHours = document.getElementById('total-study-hours');
            if (studyHours) studyHours.textContent = '35.5';
            
            const contactsEl = document.getElementById('total-contacts');
            if (contactsEl) contactsEl.textContent = allContacts.length;
            
            const activitiesEl = document.getElementById('month-activities');
            if (activitiesEl) activitiesEl.textContent = '3';
            
            const myActivitiesGrid = document.getElementById('my-recent-activities');
            if (!myActivitiesGrid) return;
            myActivitiesGrid.innerHTML = '';
            // Assuming first 3 activities are "mine"
            const myActivities = allActivities.slice(0, 3);
            if(myActivities.length === 0){
                myActivitiesGrid.innerHTML = `<div class="empty-state" style="grid-column: 1 / -1; padding: 20px;">
                    <div class="empty-icon"></div>
                    <div class="empty-title">ËøòÊ≤°ÊúâÂèÇÂä†Ê¥ªÂä®</div>
                    <div class="empty-description">Âø´ÂéªÊ¥ªÂä®ÂπøÂú∫ÁúãÁúãÊúâ‰ªÄ‰πàÊÑüÂÖ¥Ë∂£ÁöÑÊ¥ªÂä®ÂêßÔºÅ</div>
                </div>`;
                return;
            }
            myActivities.forEach(activity => {
                 myActivitiesGrid.appendChild(createActivityCard(activity));
            });
        }
        
        function renderDashboardData() {
            const ongoing = allActivities.filter(a => getActivityStatus(a).key === 'ongoing').length;
            
            // ÂÆâÂÖ®Ê£ÄÊü•ÔºöÁ°Æ‰øù DOM ÂÖÉÁ¥†Â≠òÂú®
            const totalEl = document.getElementById('dashboard-total-activities');
            if (totalEl) totalEl.textContent = allActivities.length;
            
            const ongoingEl = document.getElementById('dashboard-ongoing-activities');
            if (ongoingEl) ongoingEl.textContent = ongoing;
            
            const usageEl = document.getElementById('dashboard-resource-usage');
            if (usageEl) usageEl.textContent = '68%';
            
            const usersEl = document.getElementById('dashboard-total-users');
            if (usersEl) usersEl.textContent = '158';
        }
        
        function renderScheduleGrid() {
            const grid = document.getElementById('schedule-grid');
            if (!grid) {
                console.warn('schedule-grid ÂÖÉÁ¥†‰∏çÂ≠òÂú®');
                return;
            }
            grid.innerHTML = '';
            const locations = ['‰∏ªÊïôÂ≠¶Ê•ºA101', 'Âõæ‰π¶È¶ÜÊä•ÂëäÂéÖ', '‰ΩìËÇ≤È¶ÜÁØÆÁêÉÂú∫', 'Ëâ∫ÊúØ‰∏≠ÂøÉÁê¥Êàø'];
            const timeSlots = ['08:00-10:00', '10:00-12:00', '14:00-16:00', '16:00-18:00', '19:00-21:00'];
            const days = ['Âë®‰∏Ä', 'Âë®‰∫å', 'Âë®‰∏â', 'Âë®Âõõ', 'Âë®‰∫î', 'Âë®ÂÖ≠', 'Âë®Êó•'];
            
            grid.style.gridTemplateColumns = `120px repeat(${days.length}, 1fr)`;

            // Header row (days)
            grid.appendChild(document.createElement('div')); // Empty corner
            days.forEach(day => {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-cell calendar-header-cell';
                dayCell.textContent = day;
                grid.appendChild(dayCell);
            });

            // Data rows
            locations.forEach(location => {
                const locationCell = document.createElement('div');
                locationCell.className = 'calendar-cell calendar-time-cell';
                locationCell.textContent = location;
                grid.appendChild(locationCell);
                
                days.forEach(day => {
                    const cell = document.createElement('div');
                    // Mock conflict detection
                    const isOccupied = Math.random() > 0.7;
                    cell.className = `calendar-cell ${isOccupied ? 'calendar-occupied' : 'calendar-available'}`;
                    cell.innerHTML = `<div class="calendar-cell-content">${isOccupied ? 'Â∑≤Âç†Áî®' : 'ÂèØÁî®'}</div>`;
                    cell.title = `${location} - ${day} - ${isOccupied ? 'ÁÇπÂáªÊü•ÁúãËØ¶ÊÉÖ' : 'ÁÇπÂáªÈ¢ÑÂÆö'}`;
                    grid.appendChild(cell);
                });
            });
        }
        
        // --- ‰∫ã‰ª∂Â§ÑÁêÜ ---
        function bindFormEvents() {
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('register-form').addEventListener('submit', handleRegister);
            document.getElementById('create-activity-form').addEventListener('submit', handleCreateActivity);
            document.getElementById('create-contact-form').addEventListener('submit', handleCreateContact);
        }

        async function handleLogin(e) {
            e.preventDefault();
            clearMessages();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;

            // Simple validation
            if (!username || !password) {
                return showError("ËØ∑ËæìÂÖ•Áî®Êà∑ÂêçÂíåÂØÜÁ†Å");
            }
            if (password.length < 6) {
                return showError("ÂØÜÁ†ÅËá≥Â∞ëÈúÄË¶Å6‰Ωç");
            }
            
            try {
                showNotification('Ê≠£Âú®ÁôªÂΩï...', 'info');
                const response = await apiRequest('/api/auth/login', {
                    method: 'POST',
                    body: { username, password }
                });

                console.log('Login response:', response);

                if (response.token) {
                    authToken = response.token;
                    localStorage.setItem('authToken', authToken);
                    console.log('Token saved:', authToken.substring(0, 20) + '...');
                }
                
                if (response.user) {
                    currentUser = {
                        username: response.user.username,
                        role: response.user.role,
                        realName: response.user.real_name || response.user.username,
                        studentId: response.user.student_id || null,
                        email: response.user.email,
                        department: response.user.department
                    };
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    console.log('Current user saved:', currentUser);
                    console.log('Role:', currentUser.role);
                } else {
                    throw new Error('ÁôªÂΩïÂìçÂ∫î‰∏≠Áº∫Â∞ëÁî®Êà∑‰ø°ÊÅØ');
                }

                showSuccess("ÁôªÂΩïÊàêÂäüÔºÅÊ≠£Âú®Ë∑≥ËΩ¨...");
                setTimeout(() => {
                    console.log('Calling showMainView');
                    showMainView();
                }, 1000);
            } catch (error) {
                console.error('Login error:', error);
                showError("ÁôªÂΩïÂ§±Ë¥•: " + error.message);
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            clearMessages();
            
            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;
            const confirm = document.getElementById('register-confirm').value;
            const realname = document.getElementById('register-realname').value;
            const email = document.getElementById('register-email').value;
            const department = document.getElementById('register-college').value;
            
            // Validation
            if (!username || !password || !confirm || !realname || !email) {
                return showError("ËØ∑Â°´ÂÜôÊâÄÊúâÂøÖÂ°´Â≠óÊÆµ");
            }
            
            if (username.length < 3) {
                return showError("Áî®Êà∑ÂêçËá≥Â∞ëÈúÄË¶Å3‰Ωç");
            }
            
            if (password.length < 6) {
                return showError("ÂØÜÁ†ÅËá≥Â∞ëÈúÄË¶Å6‰Ωç");
            }
            
            if (password !== confirm) {
                return showError("‰∏§Ê¨°ËæìÂÖ•ÁöÑÂØÜÁ†Å‰∏ç‰∏ÄËá¥ÔºÅ");
            }
            
            try {
                showNotification('Ê≠£Âú®Ê≥®ÂÜå...', 'info');
                const response = await apiRequest('/api/auth/register', {
                    method: 'POST',
                    body: {
                        username,
                        password,
                        real_name: realname,
                        email,
                        department: department || '',
                        role: 'student'
                    }
                });
                
                showSuccess("Ê≥®ÂÜåÊàêÂäüÔºÅËØ∑‰ΩøÁî®Êñ∞Ë¥¶Êà∑ÁôªÂΩï„ÄÇ");
                document.getElementById('register-form').reset();
                setTimeout(() => switchAuthTab('login'), 1500);
            } catch (error) {
                console.error('Ê≥®ÂÜåÈîôËØØ:', error);
                const errorMsg = error.message || 'Êú™Áü•ÈîôËØØ';
                if (errorMsg.includes('fetch')) {
                    showError("ÁΩëÁªúËøûÊé•Â§±Ë¥•ÔºåËØ∑Á°ÆËÆ§ÂêéÁ´ØÊúçÂä°ÊòØÂê¶ËøêË°åÂú® http://localhost:8080");
                } else if (errorMsg.includes('Failed to fetch')) {
                    showError("Êó†Ê≥ïËøûÊé•Âà∞ÊúçÂä°Âô®ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•");
                } else {
                    showError("Ê≥®ÂÜåÂ§±Ë¥•: " + errorMsg);
                }
            }
        }

        
        async function handleCreateActivity(e) {
            e.preventDefault();
            const form = e.target;
            
            // ÂÆâÂÖ®Ê£ÄÊü•ÔºöÁ°Æ‰øùÊâÄÊúâ DOM ÂÖÉÁ¥†Â≠òÂú®
            const activityIdEl = document.getElementById('activity-id');
            const nameEl = document.getElementById('activity-name');
            const locationEl = document.getElementById('activity-location');
            const startEl = document.getElementById('activity-start');
            const endEl = document.getElementById('activity-end');
            const maxEl = document.getElementById('activity-max-participants');
            const categoryEl = document.getElementById('activity-category');
            const descEl = document.getElementById('activity-description');
            
            if (!activityIdEl || !nameEl || !locationEl || !startEl || !endEl || !maxEl || !categoryEl || !descEl) {
                console.error('Missing form elements for activity creation');
                return showNotification('Ë°®ÂçïÂÖÉÁ¥†Áº∫Â§±ÔºåÊó†Ê≥ïÂàõÂª∫Ê¥ªÂä®', 'error');
            }
            
            const activityId = activityIdEl.value;
            const isEditing = !!activityId;
            
            const name = nameEl.value;
            const location = locationEl.value;
            const start = startEl.value;
            const end = endEl.value;
            const maxParticipants = parseInt(maxEl.value) || 0;
            const category = categoryEl.value;
            const description = descEl.value || '';
            
            if (!name || !location || !start || !end) {
                return showNotification('ËØ∑Â°´ÂÜôÊâÄÊúâÂøÖÂ°´Â≠óÊÆµ', 'error');
            }
            
            try {
                showNotification('Ê≠£Âú®‰øùÂ≠òÊ¥ªÂä®...', 'info');
                
                console.log('Activity form data:', {
                    name, location, start, end, maxParticipants, category, description
                });
                
                // ËΩ¨Êç¢Êó∂Èó¥Ê†ºÂºèÔºödatetime-local ËæìÂÖ•ÂÄºÊ†ºÂºè‰∏∫ YYYY-MM-DDTHH:mm
                // ÈúÄË¶ÅËΩ¨Êç¢‰∏∫ ISO 8601 Ê†ºÂºèÔºöYYYY-MM-DDTHH:mm:ssZ
                const startTime = start ? new Date(start).toISOString() : '';
                const endTime = end ? new Date(end).toISOString() : '';
                
                console.log('Converted times:', { startTime, endTime });
                
                const activityData = {
                    name,
                    location,
                    start_time: startTime,
                    end_time: endTime,
                    max_participants: maxParticipants,
                    category: mapCategoryToBackend(category),
                    description
                };
                
                console.log('Final activity data:', activityData);
                
                if (isEditing) {
                    // TODO: ÂÆûÁé∞Êõ¥Êñ∞API
                    showNotification('Êõ¥Êñ∞ÂäüËÉΩÂæÖÂÆûÁé∞', 'warning');
                } else {
                    await apiRequest('/api/activities', {
                        method: 'POST',
                        body: activityData
                    });
                    showNotification(`Ê¥ªÂä®Â∑≤ÊàêÂäüÂàõÂª∫ÔºÅ`, 'success');
                }
                
                closeModal('create-activity-modal');
                await fetchAllActivities(); // Refresh list
            } catch (error) {
                showNotification('‰øùÂ≠òÂ§±Ë¥•: ' + error.message, 'error');
            }
        }
        
        function mapCategoryToBackend(category) {
            const map = {
                'zhi': 'academic',
                'ti': 'sports',
                'mei': 'cultural',
                'de': 'moral',
                'lao': 'volunteer'
            };
            return map[category] || 'academic';
        }

        async function handleCreateContact(e) {
            e.preventDefault();
            const form = e.target;
            
            const name = document.getElementById('contact-name').value;
            const phone = document.getElementById('contact-phone').value;
            const email = document.getElementById('contact-email').value;
            const department = document.getElementById('contact-department').value || '';
            
            if (!name || !phone || !email) {
                return showNotification('ËØ∑Â°´ÂÜôÊâÄÊúâÂøÖÂ°´Â≠óÊÆµ', 'error');
            }
            
            try {
                showNotification('Ê≠£Âú®‰øùÂ≠òËÅîÁ≥ª‰∫∫...', 'info');
                await apiRequest('/api/contacts', {
                    method: 'POST',
                    body: { name, phone, email, department }
                });
                
                showNotification('ËÅîÁ≥ª‰∫∫Â∑≤ÊàêÂäüÊ∑ªÂä†ÔºÅ', 'success');
                closeModal('create-contact-modal');
                await fetchAllContacts(); // Refresh list
            } catch (error) {
                showNotification('‰øùÂ≠òÂ§±Ë¥•: ' + error.message, 'error');
            }
        }

        function handleLogout() {
            currentUser = null;
            authToken = null;
            localStorage.removeItem('currentUser');
            localStorage.removeItem('authToken');
            showNotification('ÊÇ®Â∑≤ÊàêÂäüÈÄÄÂá∫ÁôªÂΩï„ÄÇ', 'info');
            setTimeout(showAuthView, 1000);
        }

        function handleJoinActivity(activityId) {
            showNotification(`ÊàêÂäüÊä•ÂêçÊ¥ªÂä®ÔºÅ`, 'success');
            // Here you would make an API call to join
            // For mock, let's just update the UI
            const activity = allActivities.find(a => a.id === activityId);
            if (activity) {
                activity.participants++;
                filterActivities();
            }
        }
        
        function searchContacts() {
            const query = document.getElementById('contact-search').value.toLowerCase();
            const filtered = allContacts.filter(c => 
                c.name.toLowerCase().includes(query) || 
                c.phone.includes(query) || 
                c.email.toLowerCase().includes(query)
            );
            renderContacts(filtered);
        }
        
        // --- Ê®°ÊÄÅÊ°ÜÊéßÂà∂ ---
        function showCreateActivityModal(activityId = null) {
            const form = document.getElementById('create-activity-form');
            form.reset();
            const modalTitle = document.getElementById('activity-modal-title');
            const submitBtn = document.getElementById('activity-submit-btn');

            if (activityId) {
                const activity = allActivities.find(a => a.id === activityId);
                if (activity) {
                    modalTitle.textContent = 'ÁºñËæëÊ¥ªÂä®';
                    submitBtn.innerHTML = '<span></span> ‰øùÂ≠òÊõ¥Êîπ';
                    document.getElementById('activity-id').value = activity.id;
                    document.getElementById('activity-name').value = activity.name;
                    document.getElementById('activity-description').value = activity.description;
                    document.getElementById('activity-location').value = activity.location;
                    document.getElementById('activity-start').value = activity.start;
                    document.getElementById('activity-end').value = activity.end;
                    document.getElementById('activity-max-participants').value = activity.maxParticipants;
                    document.getElementById('activity-category').value = activity.category;
                }
            } else {
                 modalTitle.textContent = 'ÂàõÂª∫Êñ∞Ê¥ªÂä®';
                 submitBtn.innerHTML = '<span></span> ÂàõÂª∫Ê¥ªÂä®';
                 document.getElementById('activity-id').value = '';
            }

            document.getElementById('create-activity-modal').style.display = 'flex';
        }

        function showActivityDetailModal(activityId) {
            const activity = allActivities.find(a => a.id === activityId);
            if (!activity) return;

            document.getElementById('detail-activity-title').textContent = activity.name;
            const content = document.getElementById('activity-detail-content');
            const status = getActivityStatus(activity);
            
            content.innerHTML = `
                <p style="color: var(--gray-600); font-size: 16px; margin-bottom: 24px;">${activity.description}</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div><strong> Âú∞ÁÇπ:</strong> ${activity.location}</div>
                    <div><strong> Á±ªÂà´:</strong> ${document.querySelector(`#activity-category option[value=${activity.category}]`).textContent}</div>
                    <div><strong> ÂºÄÂßãÊó∂Èó¥:</strong> ${formatDateTime(activity.start, true)}</div>
                    <div><strong> ÁªìÊùüÊó∂Èó¥:</strong> ${formatDateTime(activity.end, true)}</div>
                    <div><strong> ÂèÇ‰∏é‰∫∫Êï∞:</strong> ${activity.participants} / ${activity.maxParticipants}</div>
                    <div><strong> ÂàõÂª∫ËÄÖ:</strong> ${activity.creator}</div>
                    <div><strong> Áä∂ÊÄÅ:</strong> <span class="activity-status ${status.class}" style="font-size: 14px; padding: 6px 10px;">${status.text}</span></div>
                </div>
            `;
            document.getElementById('activity-detail-modal').style.display = 'flex';
        }

        function showCreateContactModal() {
            document.getElementById('create-contact-form').reset();
            document.getElementById('create-contact-modal').style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // --- UIËæÖÂä©ÂáΩÊï∞ ---
        function showError(message) {
            const errorDiv = document.getElementById('auth-error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('auth-success');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
        }

        function clearMessages() {
            document.getElementById('auth-error').style.display = 'none';
            document.getElementById('auth-success').style.display = 'none';
        }
        
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            const notif = document.createElement('div');
            notif.className = `notification ${type}`;
            notif.textContent = message;
            container.appendChild(notif);
            
            // Trigger animation
            setTimeout(() => notif.classList.add('show'), 10);
            
            // Auto-hide
            setTimeout(() => {
                notif.classList.remove('show');
                notif.addEventListener('transitionend', () => notif.remove());
            }, 3000);
        }

        function showLoadingSpinnerForTab(tabId, show) {
            const tabContent = document.getElementById(`tab-${tabId}`);
            if (!tabContent) return;

            let spinner = tabContent.querySelector('.loading-spinner');
            if (show) {
                if (!spinner) {
                    spinner = document.createElement('div');
                    spinner.className = 'loading-spinner';
                    // Clear content and show spinner
                    const grid = tabContent.querySelector('.activities-grid, .dashboard-grid, .profile-stats, .schedule-grid');
                    if (grid) grid.innerHTML = '';
                    if (tabId === 'profile') {
                         document.getElementById('my-recent-activities').innerHTML = '';
                    }
                    tabContent.appendChild(spinner);
                }
            } else {
                if (spinner) {
                    spinner.remove();
                }
            }
        }

        // --- Â∑•ÂÖ∑ÂáΩÊï∞ ---
        function getActivityStatus(activity) {
            const now = new Date();
            const start = new Date(activity.start);
            const end = new Date(activity.end);

            if (now < start) {
                return { key: 'upcoming', text: 'Êú™ÂºÄÂßã', class: 'status-upcoming' };
            } else if (now >= start && now <= end) {
                return { key: 'ongoing', text: 'ËøõË°å‰∏≠', class: 'status-ongoing' };
            } else {
                return { key: 'ended', text: 'Â∑≤ÁªìÊùü', class: 'status-ended' };
            }
        }
        
        function formatDateTime(isoString, withSeconds = false) {
            const date = new Date(isoString);
            const options = {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit',
                hour12: false
            };
            if(withSeconds) options.second = '2-digit';
            return date.toLocaleString('zh-CN', options).replace(/\//g, '-');
        }

    </script>
</body>
</html>